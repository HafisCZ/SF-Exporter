# frozen_string_literal: true

require 'zip'
require 'httparty'

class Upload
  include HTTParty

  URL_STORAGE = 'https://crowdin.com/api/v2/storages'
  URL_FILES_UPDATE = 'https://crowdin.com/api/v2/projects/555523/files/%<file_id>s'

  def initialize(argv:)
    @token = argv[0]
  end

  def run
    file = File.open('./en.json')

    storage_id = upload_to_storage(file)

    update_source_file(storage_id)
  end

  private

  def upload_to_storage(file)
    post(URL_STORAGE, file, headers: { 'Crowdin-API-FileName' => 'en.json' }).dig('data', 'id')
  end

  def update_source_file(storage_id)
    put(format(URL_FILES_UPDATE, file_id: 1), { 'storageId' => storage_id })
  end

  def put(url, body, headers: {})
    JSON.parse(
      self.class.put(url, headers: default_headers.merge(headers), body: body.to_json).body
    )
  end

  def post(url, body, headers: {})
    JSON.parse(
      self.class.post(url, headers: default_headers.merge(headers), body: body.to_json).body
    )
  end

  def default_headers
    {
      'Authorization' => "Bearer #{@token}",
      'Content-Type' => 'application/json'
    }
  end
end

Upload.new(argv: ARGV).run if __FILE__ == $0
