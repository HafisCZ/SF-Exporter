<!DOCTYPE html>
<html lang="en">
    <head>
        <title>SFTools - Pet Simulator</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" type="image/png" href="res/favicon.png"/>

        <link rel="stylesheet" href="css/pages/pets.css"/>

        <script src="vendor/js/jquery.3.4.1.min.js"></script>
        <script src="vendor/js/semantic.min.js"></script>
        <script src="vendor/js/html2canvas.min.js"></script>

        <script src="js/enum.js"></script>
        <script src="js/util.js"></script>

        <script src="js/core/util.js"></script>
        <script src="js/core/models.js"></script>
        <script src="js/core/core.js"></script>
        <script src="js/plugins.js"></script>
        <script src="js/core/idb.js"></script>
        <script src="js/core/ast.js"></script>
        <script src="js/stats/settings.js"></script>
        <script src="js/views.js"></script>
        <script src="endpoint/endpoint.js"></script>

        <script src="js/changelog.js"></script>
        <script src="js/sim/base.js"></script>
        <script src="js/sim/pets.js"></script>
        <script src="js/editor.js"></script>
    </head>
    <body class="inverted">
        <div class="ui fixed inverted borderless huge menu">
            <div class="header item"><a href="index.html">SFTools</a></div>
        </div>

        <div class="ui main inverted container">
            <!-- Header -->
            <div class="ui middle aligned grid">
                <div class="four wide column">
                    <div class="ui small inverted form">
                        <div class="three fields !mb-0">
                            <div class="field" data-position="bottom center" data-intl-tooltip="simulator.threads" data-inverted="">
                                <div class="ui inverted centered input">
                                    <input type="text" id="sim-threads" value="4">
                                </div>
                            </div>
                            <div class="field" data-position="bottom center" data-intl-tooltip="simulator.iterations" data-inverted="">
                                <span style="position: absolute; top: 0.5em; left: -0.25em;">x</span>
                                <div class="ui inverted centered input">
                                    <input type="text" id="sim-iterations" value="2500">
                                </div>
                            </div>
                            <div class="field" data-position="bottom center" data-intl-tooltip="pets.generate.iterations" data-inverted="">
                                <span style="position: absolute; top: 0.5em; left: -0.25em;">/</span>
                                <div class="ui inverted centered input">
                                    <input type="text" id="sim-map-iterations" value="100000">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="two wide column"></div>
                <div class="four wide column">
                    <h1 class="ui centered inverted header">Pet Simulator</h1>
                </div>
                <div class="three wide center aligned column" id="sim-result"></div>
                <div class="three wide right aligned column">
                    <div class="ui small basic inverted buttons">
                        <button class="ui button" type="submit" id="simulate" data-intl="pets.simulate"></button>
                        <div id="sim-generate" class="ui floating black simple inverted dropdown icon button">
                            <i class="ui white th icon"></i>
                            <div class="menu">
                                <div class="item" id="sim-generate1" data-intl="pets.generate.one"></div>
                                <div class="item" id="sim-generate5" data-intl="pets.generate.five"></div>
                                <div class="item" id="sim-generate10" data-intl="pets.generate.ten"></div>
                            </div>
                        </div>
                        <div id="simulate-dungeons" class="ui icon simple black button" data-position="bottom center" data-intl-tooltip="pets.simulate_dungeons" data-inverted=""><i class="ui dungeon icon"></i></div>
                    </div>
                </div>
            </div>
            <div class="ui two columns grid">
                <div class="column">
                    <div class="ui inverted form" id="sim-a">
                        <div class="ui grey inverted segment !p-2 !m-0">
                            <div class="three fields">
                                <div class="field">
                                    <label data-intl="pets.editor.type"></label>
                                    <div class="ui selection inverted dropdown" data-path="Type">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="pets.editor.pet"></label>
                                    <div class="ui search selection inverted dropdown" data-path="Pet">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <div class="two fields">
                                        <div class="field">
                                            <label data-intl="pets.editor.habitat"></label>
                                            <div class="ui selection inverted dropdown" data-path="Boss">
                                                <div class="text"></div>
                                                <i class="dropdown icon"></i>
                                            </div>
                                        </div>
                                        <div class="field">
                                            <label data-intl="editor.level"></label>
                                            <div class="ui inverted centered input">
                                                <input data-path="Level" placeholder="1 - 200">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="three fields">
                                <div class="field">
                                    <label data-intl="pets.editor.at100.title"></label>
                                    <div class="ui inverted centered input">
                                        <input data-path="At100" data-intl-placeholder="pets.editor.at100.placeholder">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="pets.editor.at150.title"></label>
                                    <div class="ui inverted centered input">
                                        <input data-path="At150" data-intl-placeholder="pets.editor.at150.placeholder">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="pets.editor.at200.title"></label>
                                    <div class="ui inverted centered input">
                                        <input data-path="At200" data-intl-placeholder="pets.editor.at200.placeholder">
                                    </div>
                                </div>
                            </div>
                            <div class="three fields !mb-0">
                                <div class="field">
                                    <label data-intl="pets.editor.pack.title"></label>
                                    <div class="ui inverted centered input">
                                        <input data-path="Pack" data-intl-placeholder="pets.editor.pack.placeholder">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.gladiator"></label>
                                    <div class="ui search selection inverted dropdown" data-path="Gladiator">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="ui grey inverted segment !p-2 !mt-2" data-debug="">
                            <div class="two fields">
                                <div class="field">
                                    <label data-intl="editor.class"></label>
                                    <div class="ui inverted centered input">
                                        <input disabled data-path="Class">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="pets.editor.health"></label>
                                    <div class="ui inverted centered input">
                                        <input disabled data-path="Health">
                                    </div>
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label data-intl="pets.editor.attribute"></label>
                                    <div class="ui inverted centered input">
                                        <input disabled data-path="Attribute">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="pets.editor.defense"></label>
                                    <div class="ui inverted centered input">
                                        <input disabled data-path="Defense">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="general.attribute5"></label>
                                    <div class="ui inverted centered input">
                                        <input disabled data-path="Luck">
                                    </div>
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label data-intl="pets.editor.skip"></label>
                                    <div class="ui inverted centered input">
                                        <input disabled data-path="Skip">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="pets.editor.crit"></label>
                                    <div class="ui inverted centered input">
                                        <input disabled data-path="Chance">
                                    </div>
                                </div>
                            </div>
                            <div class="two fields !mb-0">
                                <div class="field">
                                    <label data-intl="pets.editor.damage"></label>
                                    <div class="ui inverted centered input">
                                        <input disabled data-path="Damage">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="pets.editor.critical_bonus"></label>
                                    <div class="ui inverted centered input">
                                        <input disabled data-path="Critical">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Player list -->
                <div class="column">
                    <div class="ui inverted form" id="sim-b">
                        <div class="ui grey inverted segment !p-2 !m-0">
                            <div class="three fields">
                                <div class="field">
                                    <label data-intl="pets.editor.type"></label>
                                    <div class="ui selection inverted dropdown" data-path="Type">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="pets.editor.pet"></label>
                                    <div class="ui search selection inverted dropdown" data-path="Pet">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <div class="two fields">
                                        <div class="field">
                                            <label data-intl="pets.editor.habitat"></label>
                                            <div class="ui selection inverted dropdown" data-path="Boss">
                                                <div class="text"></div>
                                                <i class="dropdown icon"></i>
                                            </div>
                                        </div>
                                        <div class="field">
                                            <label data-intl="editor.level"></label>
                                            <div class="ui inverted centered input">
                                                <input data-path="Level" placeholder="1 - 200">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="three fields">
                                <div class="field">
                                    <label data-intl="pets.editor.at100.title"></label>
                                    <div class="ui inverted centered input">
                                        <input data-path="At100" data-intl-placeholder="pets.editor.at100.placeholder">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="pets.editor.at150.title"></label>
                                    <div class="ui inverted centered input">
                                        <input data-path="At150" data-intl-placeholder="pets.editor.at150.placeholder">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="pets.editor.at200.title"></label>
                                    <div class="ui inverted centered input">
                                        <input data-path="At200" data-intl-placeholder="pets.editor.at200.placeholder">
                                    </div>
                                </div>
                            </div>
                            <div class="three fields !mb-0">
                                <div class="field">
                                    <label data-intl="pets.editor.pack.title"></label>
                                    <div class="ui inverted centered input">
                                        <input data-path="Pack" data-intl-placeholder="pets.editor.pack.placeholder">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.gladiator"></label>
                                    <div class="ui search selection inverted dropdown" data-path="Gladiator">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="ui grey inverted segment !p-2 !mt-2" data-debug="">
                            <div class="two fields">
                                <div class="field">
                                    <label data-intl="editor.class"></label>
                                    <div class="ui inverted centered input">
                                        <input disabled data-path="Class">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="pets.editor.health"></label>
                                    <div class="ui inverted centered input">
                                        <input disabled data-path="Health">
                                    </div>
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label data-intl="pets.editor.attribute"></label>
                                    <div class="ui inverted centered input">
                                        <input disabled data-path="Attribute">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="pets.editor.defense"></label>
                                    <div class="ui inverted centered input">
                                        <input disabled data-path="Defense">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="general.attribute5"></label>
                                    <div class="ui inverted centered input">
                                        <input disabled data-path="Luck">
                                    </div>
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label data-intl="pets.editor.skip"></label>
                                    <div class="ui inverted centered input">
                                        <input disabled data-path="Skip">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="pets.editor.crit"></label>
                                    <div class="ui inverted centered input">
                                        <input disabled data-path="Chance">
                                    </div>
                                </div>
                            </div>
                            <div class="two fields !mb-0">
                                <div class="field">
                                    <label data-intl="pets.editor.damage"></label>
                                    <div class="ui inverted centered input">
                                        <input disabled data-path="Damage">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="pets.editor.critical_bonus"></label>
                                    <div class="ui inverted centered input">
                                        <input disabled data-path="Critical">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            const SIMULATOR_RESULTS_DIALOG = new (class extends Dialog {
                constructor () {
                    super({
                        dismissable: true
                    })
                }

                _createModal () {
                    return `
                        <div class="small inverted bordered dialog">
                            <div class="header">${intl('pets.results')}</div>
                            <div class="ui three column grid" data-op="content"></div>
                        </div>
                    `;
                }

                _createBindings () {
                    this.$content = this.$parent.operator('content');
                }

                _applyArguments (results) {
                    this.$content.html(results.map(({ chance, player, boss }) => {
                        const playerIndex = 20 * player.Type + player.Pet;
                        const bossIndex = 20 * boss.Type + boss.Pet;

                        return `
                            <div class="two wide column">
                                <img src="res/pets/monster${800 + playerIndex}.png" style="height: 3em;">
                            </div>
                            <div class="four wide column" style="line-height: 3em; font-size: 110%;">
                                ${intl(`pets.names.${playerIndex}`)}
                            </div>
                            <div class="two wide column">
                                <img src="res/pets/monster${800 + bossIndex}.png" style="height: 3em;">
                            </div>
                            <div class="four wide column" style="line-height: 3em; font-size: 110%;">
                                ${intl(`pets.names.${bossIndex}`)}
                            </div>
                            <div class="four wide column text-center" style="line-height: 3em;">
                                ${chance == 0 ? intl('pets.bulk.not_possible') : `${chance.toFixed(chance < 0.01 ? 5 : 2)}%`}
                            </div>
                        `;
                    }).join(''))
                }
            })();

            SIMULATOR_MAP_DIALOG = new (class extends Dialog {
                constructor () {
                    super({
                        dismissable: true
                    })
                }

                _createModal () {
                    return `
                        <div class="very big inverted bordered dialog">
                            <div class="header">${intl('pets.results')}</div>
                            <div class="flex justify-content-between gap-2">
                                <div class="ui selection fluid inverted dropdown" data-op="selector">
                                    <div class="text"></div>
                                    <i class="dropdown icon"></i>
                                </div>
                                <div class="ui basic inverted icon button" data-position="bottom center" data-inverted="" data-tooltip="${intl('stats.copy.image')}" data-op="save">
                                    <i class="download icon"></i>
                                </div>
                            </div>
                            <div data-op="content" class="overflow-y-scroll" style="height: 50vh;"></div>
                        </div>
                    `;
                }

                _createBindings () {
                    this.$selector = this.$parent.operator('selector');
                    
                    this.$save = this.$parent.operator('save');
                    this.$save.click(() => {
                        const name = this.$selector.dropdown('get value');
                        this._save(name);
                    });

                    this.$content = this.$parent.operator('content');
                }

                _save (name) {
                    const $element = this.$parent.find(`[data-map="${name}"]`);
                    
                    this.$content.css('height', '');
                    $element.find('.\\!text-white, .text-white').attr('style', 'color: black !important;');

                    html2canvas($element.get(0), {
                        logging: false,
                        onclone: () => {
                            this.$content.css('height', '50vh');
                            $element.find('.\\!text-white, .text-white').removeAttr('style');
                        }
                    }).then((canvas) => {
                        canvas.toBlob((blob) => {
                            window.download(`${name}.png`, blob);
                        });
                    });
                }

                _color (chance) {
                    if (chance < 0.01) {
                        return '#ffad99';
                    } else if (chance >= 25) {
                        return '#99ffb4'
                    } else if (chance >= 10) {
                        return '#daff99';
                    } else if (chance >= 5) {
                        return '#fdff99';
                    } else {
                        return '#ffdd99';
                    }
                }

                _applyArguments (maps) {
                    this.$selector.dropdown({
                        values: maps.map(({ name }) => ({ value: SHA1(name), name })),
                        onChange: (value) => {
                            this.$content.find('[data-map]').hide();
                            this.$content.find(`[data-map="${value}"]`).show();
                        }
                    });

                    let content = '';
                    for (const { data, name } of maps) {
                        const size = data.find(entry => entry && entry.length).filter(value => typeof value !== 'undefined').length;

                        content += `
                            <table data-map="${SHA1(name)}" class="ui celled structured fixed basic table w-full text-center !m-0" style="display: none; font-size: 90% !important;">
                                <thead>
                                    <tr>
                                        ${data.find(entry => entry && entry.length).reduce((memo, chance, i) => memo + `<th class="!text-white">${intl('pets.map.gladiator')} ${i}</th>`, `<th class="!text-white">${intl('editor.level')}</th>`)}
                                        ${'<th></th>'.repeat(16 - size)}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.reduce((memo, entry, i) => memo + `<tr><td class="text-white">${i + 1}</td>${ entry.reduce((memo2, chance) => memo2 + `<td style="background-color: ${this._color(chance)};">${chance.toFixed(2)}%</td>`, '')}${'<td></td>'.repeat(16 - size)}</tr>`, '')}
                                </tbody>
                            </table>
                        `;
                    }

                    this.$content.html(content);

                    this.$selector.dropdown('set selected', SHA1(maps[0].name));
                }
            })();

            Site.ready({ type: 'simulator' }, function () {
                $('#sim-threads').captiveInputField('pet_sim/threads', 4, v => !isNaN(v) && v >= 1);
                $('#sim-iterations').captiveInputField('pet_sim/iterations', 2.5E6, v => !isNaN(v) && v >= 1);
                $('#sim-map-iterations').captiveInputField('pet_sim/map_iterations', 1E5, v => !isNaN(v) && v >= 1);

                const IGNORED_FIELDS = ['class', 'health', 'attribute', 'defense', 'luck', 'skip', 'damage', 'chance', 'critical'];
                const NON_BOSS_FIELDS = ['level', 'at100', 'at150', 'at200', 'pack', 'gladiator'];

                class PetController {
                    constructor (root, index) {
                        this.Index = index;

                        this.fields = {
                            type: new Field(`${root} [data-path="Type"]`, '0'),
                            pet: new Field(`${root} [data-path="Pet"]`, '0'),
                            boss: new Field(`${root} [data-path="Boss"]`, '0'),
                            level: new Field(`${root} [data-path="Level"]`, '', Field.isPetLevel),
                            at100: new Field(`${root} [data-path="At100"]`, '', Field.isPetCount),
                            at150: new Field(`${root} [data-path="At150"]`, '', Field.isPetCount),
                            at200: new Field(`${root} [data-path="At200"]`, '', Field.isPetCount),
                            pack: new Field(`${root} [data-path="Pack"]`, '', Field.isPetCount),
                            gladiator: new Field(`${root} [data-path="Gladiator"]`, '0'),

                            class: new Field(`${root} [data-path="Class"]`, '?'),
                            health: new Field(`${root} [data-path="Health"]`, '?'),
                            attribute: new Field(`${root} [data-path="Attribute"]`, '?'),
                            defense: new Field(`${root} [data-path="Defense"]`, '?'),
                            luck: new Field(`${root} [data-path="Luck"]`, '?'),
                            skip: new Field(`${root} [data-path="Skip"]`, '?'),
                            damage: new Field(`${root} [data-path="Damage"]`, '?'),
                            chance: new Field(`${root} [data-path="Chance"]`, '?'),
                            critical: new Field(`${root} [data-path="Critical"]`, '?')
                        };

                        this.fields['gladiator'].$object.dropdown({
                            values: [
                                { name: intl('pets.editor.none'), value: 0 },
                                ... [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15 ].map((gladiator) => {
                                    return {
                                        name: `${ gladiator } (${ gladiator * 5 }%)`,
                                        value: gladiator
                                    }
                                })
                            ]
                        }).dropdown('set selected', '0');

                        this.fields['boss'].$object.dropdown({
                            values: [
                                { name: intl('general.no'), value: 0 },
                                { name: intl('general.yes'), value: 1 }
                            ]
                        }).dropdown('setting', 'onChange', (value, text) => {
                            for (let name of NON_BOSS_FIELDS) {
                                this.fields[name].toggle(value == 0);
                            }
                        }).dropdown('set selected', '0');

                        this.fields['pet'].$object.dropdown({
                            fullTextSearch: true,
                            preserveHTML: true,
                            values: new Array(100).fill(0).map((_ , i) => {
                                return {
                                    name: `<img class="ui centered image pet-picture" src="res/pets/monster${ 800 + i }.png"><span class="pet-name">${intl(`pets.names.${i}`)}</span>`,
                                    value: i
                                };
                            })
                        }).dropdown('set selected', '0');

                        this.fields['type'].$object.dropdown({
                            values: [0, 1, 2, 3, 4].map((index) => {
                                return {
                                    name: intl(`pets.types.${index}`),
                                    value: index
                                }
                            })
                        }).dropdown('set selected', '0');

                        this.$debugDisplay = $(`${root} [data-debug]`);
                        this.$debugDisplay.hide();

                        for (let [name, field] of Object.entries(this.fields)) {
                            if (!IGNORED_FIELDS.includes(name)) {
                                field.setListener(() => this.changeListener(name));
                                field.triggerAlways = true;
                            }
                        }
                    }

                    fill (object) {
                        if (object) {
                            for (var [key, field] of Object.entries(this.fields)) {
                                if (IGNORED_FIELDS.includes(key)) {
                                    field.clear();
                                } else if (key == 'pet') {
                                    field.set(object.Type * 20 + object.Pet);
                                } else {
                                    field.set(getObjectAt(object, field.path()));
                                }
                            }
                        } else {
                            for (var [key, field] of Object.entries(this.fields)) {
                                field.clear();
                            }
                        }
                    }

                    read () {
                        const object = {};

                        for (const [key, field] of Object.entries(this.fields)) {
                            if (IGNORED_FIELDS.includes(key)) {
                                continue;
                            } else if (key == 'pet') {
                                setObjectAt(object, field.path(), field.get() % 20);
                            } else {
                                setObjectAt(object, field.path(), field.get());
                            }
                        }

                        return object;
                    }

                    valid () {
                        const isBoss = this.fields['boss'].get() == 1;

                        for (const [key, field] of Object.entries(this.fields)) {
                            const isIgnoredField = IGNORED_FIELDS.includes(key);
                            const isBossIgnoredField = isBoss && NON_BOSS_FIELDS.includes(key);

                            if (!isIgnoredField && !isBossIgnoredField && !field.valid()) {
                                return false;
                            }
                        }

                        return true;
                    }

                    changeListener (name) {
                        if (IGNORED_FIELDS.includes(name) || this._ignoreChanges) return;

                        if (name == 'type') {
                            const type = this.fields['type'].get();

                            this.fields['pet'].set(type * 20);
                            this.fields['pet'].$object.find('.item').each((i, e) => {
                                const $e = $(e);
                                const id = parseInt($e.attr('data-value'));

                                if (Math.trunc(id / 20) == type) {
                                    $e.show();
                                } else {
                                    $e.hide();
                                }
                            });
                        }

                        if (this.valid()) {
                            this.model = PetModel.fromObject(this.read());
                            this.$debugDisplay.show();
                        } else {
                            this.model = false;
                            this.$debugDisplay.hide();
                        }

                        refreshModels();
                    }

                    fillDebugInformation (model, initialized) {
                        this.fields['class'].set(intl(`general.class${model.Player.Class}`));
                        this.fields['health'].set(formatAsSpacedNumber(model.TotalHealth, ' '));
                        this.fields['attribute'].set(formatAsSpacedNumber(model.Player[model.Config.Attribute].Total, ' '));
                        this.fields['defense'].set(formatAsSpacedNumber(model.Player[model.Config.Attribute === 'Strength' ? 'Intelligence' : 'Strength'].Total, ' '));
                        this.fields['luck'].set(formatAsSpacedNumber(model.Player.Luck.Total, ' '));

                        if (initialized) {
                            this.fields['skip'].set(model.SkipChance > 0 ? `${ model.SkipChance.toFixed(2) }%` : intl('pets.editor.none'));
                            this.fields['damage'].set(formatAsSpacedNumber(model.Weapon1.Min, ' '));
                            this.fields['chance'].set(model.CriticalChance > 0 ? `${ model.CriticalChance.toFixed(2) }%` : intl('pets.editor.none'));
                            this.fields['critical'].set(`${ Math.round(100 * model.CriticalMultiplier) }%`);
                        } else {
                            for (let name of ['skip', 'damage', 'chance', 'critical']) {
                                this.fields[name].clear();
                            }
                        }
                    }
                };

                function refreshModels () {
                    const a = petA.model;
                    const b = petB.model;

                    if (a && b) {
                        a.initialize(b);
                        b.initialize(a);

                        petA.fillDebugInformation(a, true);
                        petB.fillDebugInformation(b, true);
                    } else if (a) {
                        a.initialize(a);

                        petA.fillDebugInformation(a, false);
                    } else if (b) {
                        b.initialize(b);

                        petB.fillDebugInformation(b, false);
                    }

                    if (petA.valid() && petB.valid() && petA.fields['boss'].get() == 0 && petB.fields['boss'].get() == 1) {
                        $('#sim-generate').removeClass('disabled');
                    } else {
                        $('#sim-generate').addClass('disabled');
                    }
                }

                const petA = new PetController('#sim-a', 0);
                const petB = new PetController('#sim-b', 1);
                
                petA.fill();
                petA.valid();

                petB.fill();
                petB.valid();
                
                let player = null;
                function updateDungeonButton (withPlayer = null) {
                    player = withPlayer;

                    if (player && player.Pets.Dungeons.some(pet => pet < 20)) {
                        $('#simulate-dungeons').removeClass('disabled');
                    } else {
                        $('#simulate-dungeons').addClass('disabled');
                    }
                }

                updateDungeonButton(null);

                $('#simulate-dungeons').click(function () {
                    const instances = Math.max(1, Number($('#sim-threads').val()) || 4);
                    const iterations = Math.max(1, Number($('#sim-iterations').val()) || 2.5E6);
    
                    if (player && player.Pets.Dungeons.some(pet => pet < 20)) {
                        let results = [];

                        const batch = new WorkerBatch('pets');

                        for (let type = 0; type < 5; type++) {
                            for (let klass = 1; klass <= 3; klass++) {
                                const [pet1, pet2] = getPetsFor(player, type, klass);
                                if (pet1 && pet2) {
                                    batch.add(
                                        ({ results: _results }) => {
                                            results.push({
                                                chance: _results,
                                                player: pet1,
                                                boss: pet2
                                            })
                                        },
                                        {
                                            mode: 'pet',
                                            players: [pet1, pet2],
                                            iterations
                                        }
                                    )
                                }
                            }
                        }

                        Toast.info(intl('pets.bulk.toast.title'), `<b>${intl('pets.bulk.toast.matches')}</b> ${batch.size()}`);

                        batch.run(instances).then(() => {
                            _sort_des(results, i => i.chance);

                            const resultClasses = [0, 0, 0, 0, 0];

                            DialogController.open(
                                SIMULATOR_RESULTS_DIALOG,
                                results.filter(({ player }) => ++resultClasses[player.Type] == 1)
                            )
                        })
                    }
                })

                $('#simulate').click(function () {
                    const instances = Math.max(1, Number($('#sim-threads').val()) || 4);
                    const iterations = Math.max(1, Number($('#sim-iterations').val()) || 2.5E6);

                    if (petA.valid() && petB.valid()) {
                        const results = [];

                        const batch = new WorkerBatch('pets');

                        for (let i = 0; i < instances; i++) {
                            batch.add(
                                ({ results: _results }) => {
                                    results.push(_results);
                                },
                                {
                                    mode: 'pet',
                                    players: [petA.read(), petB.read()],
                                    iterations
                                }
                            )
                        }

                        batch.run(instances).then(() => {
                            const chance = _sum(results) / instances;

                            $('#sim-result').html(chance.toFixed(chance < 0.01 ? 5 : 2) + '%');
                        })
                    }
                });

                function generatePetMap (mapCount) {
                    const instances = Math.max(1, Number($('#sim-threads').val()) || 4);
                    const iterations = Math.max(1, Number($('#sim-map-iterations').val()) || 1E5);

                    if (petA.valid() && petB.valid()) {
                        const a = petA.read();
                        const b = petB.read();

                        if (a && b && !a.Boss && b.Boss) {
                            const maps = [];

                            const batch = new WorkerBatch('pets');
                            
                            for (let i = b.Pet; i < Math.min(20, b.Pet + mapCount); i++) {
                                batch.add(
                                    ({ results }) => {
                                        maps[i - b.Pet] = results;
                                    },
                                    {
                                        mode: 'map',
                                        players: [a, Object.assign({}, b, { Pet: i })],
                                        iterations
                                    }
                                )
                            }

                            batch.run(instances).then(() => {
                                DialogController.open(
                                    SIMULATOR_MAP_DIALOG,
                                    maps.map((data, i) => ({
                                        data,
                                        name: `${intl(`pets.types.${a.Type}`)} ${ a.Pet + 1 } - ${intl(`pets.names.${a.Type * 20 + a.Pet}`)} (${ a.Pack }, ${ a.At100 }, ${ a.At150 }, ${ a.At200 }) vs ${intl(`pets.types.${b.Type}`)} ${ b.Pet + i + 1 } - ${intl(`pets.names.${b.Type * 20 + b.Pet + i}`)}`
                                    }))
                                )
                            })
                        }
                    }
                }

                $('#sim-generate1').click(() => generatePetMap(1));
                $('#sim-generate5').click(() => generatePetMap(5));
                $('#sim-generate10').click(() => generatePetMap(10));

                StatisticsIntegration.configure({
                    profile: SELF_PROFILE,
                    type: 'players',
                    dark: true,
                    scope: (dm) => dm.getLatestPlayers().filter((player) => typeof player.Pets !== 'undefined' && player.Pets.TotalLevel),
                    callback: (player) => {
                        updateDungeonButton(player);

                        const [playerPet, bossPet] = getPetsFor(player, petA.fields['type'].get(), null);
                        petA.fill(playerPet);
                        petB.fill(bossPet);

                        refreshModels();
                    }
                });

                function getPetsFor (player, type, petClass) {
                    let currentType = type;
                    let currentName = [
                        'Shadow', 'Light', 'Earth', 'Fire', 'Water'
                    ][currentType];

                    let gladiator = _try(player.Fortress, 'Gladiator') || 0;
                    let pack = player.Pets[`${currentName}Count`];
                    let petLevels = player.Pets[`${currentName}Levels`];
                    let at100 = _len_where(petLevels, l => _between(l, 100 - 1, 150));
                    let at150 = _len_where(petLevels, l => _between(l, 150 - 1, 200));
                    let at200 = _len_where(petLevels, l => l == 200);

                    let pets = petLevels.map((level, i) => {
                        return {
                            Gladiator: gladiator,
                            Pet: i,
                            Type: currentType,
                            Boss: 0,
                            Level: level,
                            Pack: pack,
                            At100: at100,
                            At150: at150,
                            At200: at200
                        }
                    });

                    let pet1 = null;
                    let pet2 = null;

                    // Boss
                    let dungeonPet = player.Pets.Dungeons[currentType];
                    if (dungeonPet < 20) {
                        pet2 = {
                            Gladiator: 0,
                            Pet: dungeonPet,
                            Type: currentType,
                            Boss: 1,
                            Level: 0,
                            Pack: 0,
                            At100: 0,
                            At150: 0,
                            At200: 0
                        };
                    }

                    let petModels = _sort_des(pets.filter((data) => data.Level).map((data) => {
                        const model = PetModel.fromObject(data);
                        
                        model.initialize(model);

                        return model;
                    }), model => model.TotalHealth);
                    let bestPet = petModels.find(model => model.Player.Class == petClass);
                    if (petClass == null && !bestPet) {
                        bestPet = petModels[0];
                    }

                    if (bestPet) {
                        pet1 = pets[bestPet.Player.Pet];
                        pet1.Class = bestPet.Player.Class;
                    }

                    return [pet1, pet2];
                }
            });
        </script>
    </body>
</html>
