<!DOCTYPE html>
<html lang="en">
    <head>
        <title>SFTools - Fight Analyzer</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" type="image/png" href="res/favicon.png"/>

        <link rel="stylesheet" href="css/pages/analyzer.css"/>

        <script src="vendor/js/jquery.3.4.1.min.js"></script>
        <script src="vendor/js/semantic.min.js"></script>
        <script src="vendor/js/sentry.bundle.min.js"></script>

        <script src="js/enum.js"></script>
        <script src="js/util.js"></script>
        <script src="js/lang.js"></script>

        <script src="js/core/util.js"></script>
        <script src="js/core/playa.js"></script>
        <script src="js/core/core.js"></script>
        <script src="js/plugins.js"></script>
        <script src="js/core/idb.js"></script>
        <script src="js/core/ast.js"></script>
        <script src="js/stats/settings.js"></script>        
        <script src="js/changelog.js"></script>
        <script src="js/views.js"></script>

        <script src="js/sim/dungeon_data.js"></script>

        <script src="js/sim/base.js"></script>
        <script src="js/sim/debug_utils.js"></script>
    </head>
    <body class="inverted">
        <div class="ui fixed inverted borderless huge menu" style="z-index: 3;">
            <div class="header item"><a href="index.html">SFTools</a></div>
            <label for="button-upload">
                <a class="item"><i class="upload icon"></i> <span data-intl="analyzer.topbar.import"></span></a>
            </label>
            <input type="file" accept=".har,.json" class="ui invisible file input" id="button-upload">
            <a class="item" id="button-clear"><i class="trash alternate outline icon"></i> <span data-intl="analyzer.topbar.clear"></span></a>
        </div>

        <div class="ui main inverted container mb-20" style="width: 65vw;">
            <div class="ui small inverted form">
                <div class="field">
                    <label data-intl="analyzer.form.fight_group"></label>
                    <div class="ui selection inverted dropdown" data-op="fight-group">
                        <div class="text"></div>
                        <i class="dropdown icon"></i>
                    </div>
                </div>
            </div>
            <h3 class="ui inverted centered header" data-intl="analyzer.players"></h3>
            <div class="ui two column grid">
                <div class="column">
                    <div class="ui grey inverted segment">
                        <div class="ui small inverted form" data-op="player1">
                            <h4 class="ui centered inverted header" data-intl="analyzer.form.player1"></h4>
                            <div class="three fields">
                                <div class="field">
                                    <label data-intl="editor.name"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" disabled data-op="name">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.class"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" disabled data-op="class">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.level"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" disabled data-op="level">
                                    </div>
                                </div>
                            </div>
                            <div class="five fields">
                                <div class="field">
                                    <label data-intl="general.attribute1"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" disabled data-op="strength">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="general.attribute2"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" disabled data-op="dexterity">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="general.attribute3"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" disabled data-op="intelligence">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="general.attribute4"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" disabled data-op="constitution">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="general.attribute5"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" disabled data-op="luck">
                                    </div>
                                </div>
                            </div>
                            <h4 class="ui centered inverted header" data-intl="analyzer.form.editable_data"></h4>
                            <div class="four fields" data-op="weapon1">
                                <div class="field">
                                    <label data-intl="editor.min"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="weapon1.min" data-intl-placeholder="editor.min_placeholder">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.max"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="weapon1.max" data-intl-placeholder="editor.max_placeholder">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.rune"></label>
                                    <div class="ui inverted centered input">
                                        <div class="ui selection inverted fluid dropdown" data-op="weapon1.rune_type">
                                            <div class="text"></div>
                                            <i class="dropdown icon"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label><br/></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="weapon1.rune_value" placeholder="0 - 60">
                                    </div>
                                </div>
                            </div>
                            <div class="four fields" data-op="weapon2">
                                <div class="field">
                                    <label data-intl="editor.min"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="weapon2.min" data-intl-placeholder="editor.min_placeholder">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.max"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="weapon2.max" data-intl-placeholder="editor.max_placeholder">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.rune"></label>
                                    <div class="ui inverted centered input">
                                        <div class="ui selection inverted fluid dropdown" data-op="weapon2.rune_type">
                                            <div class="text"></div>
                                            <i class="dropdown icon"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label><br/></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="weapon2.rune_value" placeholder="0 - 60">
                                    </div>
                                </div>
                            </div>
                            <div class="four fields">
                                <div class="field">
                                    <label data-intl="editor.armor"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="armor" data-intl-placeholder="editor.armor_placeholder">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.fire"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="resistance_fire" placeholder="0 - 75">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.cold"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="resistance_cold" placeholder="0 - 75">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.lightning"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="resistance_lightning" placeholder="0 - 75">
                                    </div>
                                </div>
                            </div>
                            <div class="three fields !mb-0">
                                <div class="field">
                                    <label data-intl="editor.portal_damage"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="dungeon" placeholder="0 - 50">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.gladiator"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="gladiator" placeholder="0 - 15">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.weapon_enchant"></label>
                                    <div class="ui selection inverted dropdown" data-op="enchant">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div class="ui grey inverted segment">
                        <div class="ui small inverted form" data-op="player2">
                            <h4 class="ui centered inverted header" data-intl="analyzer.form.player2"></h4>
                            <div class="three fields">
                                <div class="field">
                                    <label data-intl="editor.name"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" disabled data-op="name">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.class"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" disabled data-op="class">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.level"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" disabled data-op="level">
                                    </div>
                                </div>
                            </div>
                            <div class="five fields">
                                <div class="field">
                                    <label data-intl="general.attribute1"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" disabled data-op="strength">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="general.attribute2"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" disabled data-op="dexterity">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="general.attribute3"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" disabled data-op="intelligence">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="general.attribute4"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" disabled data-op="constitution">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="general.attribute5"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" disabled data-op="luck">
                                    </div>
                                </div>
                            </div>
                            <h4 class="ui centered inverted header" data-intl="analyzer.form.editable_data"></h4>
                            <div class="four fields" data-op="weapon1">
                                <div class="field">
                                    <label data-intl="editor.min"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="weapon1.min" data-intl-placeholder="editor.min_placeholder">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.max"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="weapon1.max" data-intl-placeholder="editor.max_placeholder">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.rune"></label>
                                    <div class="ui inverted centered input">
                                        <div class="ui selection inverted fluid dropdown" data-op="weapon1.rune_type">
                                            <div class="text"></div>
                                            <i class="dropdown icon"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label><br/></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="weapon1.rune_value" placeholder="0 - 60">
                                    </div>
                                </div>
                            </div>
                            <div class="four fields" data-op="weapon2">
                                <div class="field">
                                    <label data-intl="editor.min"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="weapon2.min" data-intl-placeholder="editor.min_placeholder">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.max"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="weapon2.max" data-intl-placeholder="editor.max_placeholder">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.rune"></label>
                                    <div class="ui inverted centered input">
                                        <div class="ui selection inverted fluid dropdown" data-op="weapon2.rune_type">
                                            <div class="text"></div>
                                            <i class="dropdown icon"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label><br/></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="weapon2.rune_value" placeholder="0 - 60">
                                    </div>
                                </div>
                            </div>
                            <div class="four fields">
                                <div class="field">
                                    <label data-intl="editor.armor"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="armor" data-intl-placeholder="editor.armor_placeholder">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.fire"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="resistance_fire" placeholder="0 - 75">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.cold"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="resistance_cold" placeholder="0 - 75">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.lightning"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="resistance_lightning" placeholder="0 - 75">
                                    </div>
                                </div>
                            </div>
                            <div class="three fields !mb-0">
                                <div class="field">
                                    <label data-intl="editor.portal_damage"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="dungeon" placeholder="0 - 50">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.gladiator"></label>
                                    <div class="ui inverted centered input">
                                        <input type="text" data-op="gladiator" placeholder="0 - 15">
                                    </div>
                                </div>
                                <div class="field">
                                    <label data-intl="editor.weapon_enchant"></label>
                                    <div class="ui selection inverted dropdown" data-op="enchant">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <h3 class="ui inverted centered header" data-intl="analyzer.fight"></h3>
        </div>

        <script type="text/javascript">
            Site.ready(null, function (urlParams) {
                // Upload button
                $('#button-upload').on('change', async (fileEvent) => {
                    Loader.toggle(true);

                    Promise.all(Array.from(fileEvent.currentTarget.files).map((file) => file.text().then((text) => {
                        digestHAR(JSON.parse(text));
                    })));

                    Loader.toggle(false);
                })

                // Utils
                SimulatorUtils.configure({
                    params: urlParams
                });

                // Decode attack type
                function decodeAttackType (attackType) {
                    if (attackType >= ATTACK_REVIVE) {
                        return {
                            attackSecondary: false,
                            attackCrit: false,
                            attackMissed: false,
                            attackSpecial: true
                        }
                    } else {
                        const attackSecondary = [                     
                            ATTACK_SECONDARY_NORMAL,
                            ATTACK_SECONDARY_CRITICAL,
                            ATTACK_SECONDARY_BLOCKED,
                            ATTACK_SECONDARY_EVADED,
                            ATTACK_SECONDARY_CRITICAL_BLOCKED,
                            ATTACK_SECONDARY_CRITICAL_EVADED
                        ].includes(attackType);

                        const attackChained = [
                            ATTACK_CHAIN_NORMAL,
                            ATTACK_CHAIN_CRITICAL,
                            ATTACK_CHAIN_BLOCKED,
                            ATTACK_CHAIN_EVADED,
                            ATTACK_CHAIN_CRITICAL_BLOCKED,
                            ATTACK_CHAIN_CRITICAL_EVADED
                        ].includes(attackType);
                        
                        const attackCrit = [
                            ATTACK_CRITICAL,
                            ATTACK_CRITICAL_BLOCKED,
                            ATTACK_CRITICAL_EVADED
                        ].includes(attackType % 10);

                        const attackMissed = [
                            ATTACK_BLOCKED,
                            ATTACK_EVADED,
                            ATTACK_CRITICAL_BLOCKED,
                            ATTACK_CRITICAL_EVADED
                        ].includes(attackType % 10);

                        return {
                            attackSecondary,
                            attackCrit,
                            attackMissed,
                            attackChained,
                            attackSpecial: false
                        }
                    }
                }

                // Create fighter model
                function createFighterModel (player) {
                    const model = FighterModel.create(null, player);

                    model.Config = SimulatorUtils.config || model.Config;

                    return model;
                }

                // Compute item hash
                function computeItemHash (item, player = null, secondary = false) {
                    if (item.AttributeTypes[0] == 0) {
                        return '';
                    } else {
                        const json = [
                            item.DamageMin,
                            item.DamageMax,
                            item.Enchantment,
                            item.RuneType,
                            item.RuneValue,
                            item.GemType,
                            item.GemValue
                        ];

                        if (player) {
                            // Fix weapon damage (is not clamped by fist damage)
                            const baseDamage = player.Model.getBaseDamage(secondary);

                            json[0] = Math.max(baseDamage.Min, json[0]);
                            json[1] = Math.max(baseDamage.Max, json[1]);
                        }

                        return SHA1(JSON.stringify(json));
                    }
                }

                // Compute player hash
                function computePlayerHash (player) {
                    const json = [
                        player.ID,
                        player.Class,
                        player.Level
                    ];

                    if (player instanceof SFFighter) {
                        json.push(
                            player.Strength,
                            player.Dexterity,
                            player.Intelligence,
                            player.Constitution,
                            player.Luck,
                            computeItemHash(player.Wpn1),
                            player.Class == ASSASSIN ? computeItemHash(player.Wpn2) : ''
                        )
                    } else if (player instanceof SFPlayer) {
                        json.push(
                            player.Strength.Total,
                            player.Dexterity.Total,
                            player.Intelligence.Total,
                            player.Constitution.Total,
                            player.Luck.Total,
                            computeItemHash(player.Items.Wpn1, player, false),
                            player.Class == ASSASSIN ? computeItemHash(player.Items.Wpn2, player, true) : ''
                        )
                    }

                    return SHA1(JSON.stringify(json));
                }

                // Extract individual fights from raw data array
                function digestHAR (json) {
                    const digestedFights = [];
                    const digestedPlayers = [];

                    // Capture all relevant data
                    for (const { text } of PlayaResponse.search(json)) {
                        if (text.includes('fightheader')) {
                            const r = PlayaResponse.fromText(text);

                            if (r.fightheader1) {
                                // Shadow or guild fights use indexed fight data
                                const count = _fast_max(
                                    Object.keys(r)
                                    .filter((key) => key.startsWith('fightheader'))
                                    .map((key) => parseInt(key.match(/(\d*)$/)[0] || '1'))
                                );

                                for (let i = 1; i <= count; i++) {
                                    digestedFights.push({
                                        header: r[`fightheader${i}`].mixed,
                                        rounds: r[`fight${i}`].numbers,
                                        winner_id: r[`winnerid${i}`].number
                                    });
                                }
                            } else {
                                digestedFights.push({
                                    header: r.fightheader.mixed,
                                    rounds: r.fight.numbers,
                                    winner_id: r.winnerid.number
                                });
                            }
                        }
                        
                        if (text.includes('playerlookat') || text.includes('ownplayersave')) {
                            const r = PlayaResponse.fromText(text);

                            if (r.ownplayersave) {
                                // Read only necessary data from own player
                                digestedPlayers.push({
                                    own: true,
                                    save: r.ownplayersave.numbers,
                                    name: _try(r.ownplayername, 'string'),
                                    pets: _try(r.ownpets, 'numbers'),
                                    tower: _try(r.owntower, 'numbers')
                                })
                            } else if (r['#ownplayersave']) {
                                // Capture save delta
                                const lastPlayer = digestedPlayers.findLast((entry) => entry.own && entry.name);
                                if (lastPlayer) {
                                    const save = Array.from(lastPlayer.save);

                                    for (const [index, value] of _each_block(r['#ownplayersave'].numbers, 2)) {
                                        save[index] = value;
                                    }

                                    digestedPlayers.push({
                                        own: true,
                                        save,
                                        name: lastPlayer.name,
                                        pets: _try(r.ownpets, 'numbers') || lastPlayer.pets,
                                        tower: _try(r.owntower, 'numbers') || lastPlayer.tower
                                    })
                                }
                            } else {
                                digestedPlayers.push({
                                    own: false,
                                    save: r.otherplayer.numbers,
                                    name: r.otherplayername.string,
                                    pets: _try(r.otherplayerpetbonus, 'numbers'),
                                    tower: null
                                })
                            }
                        }
                    }

                    const processedFights = [];
                    for (const { header, rounds, winner_id } of digestedFights) {
                        const fightType = header[0];

                        // Proceed only if type of fight is known to the system
                        if (Object.values(FIGHT_TYPES).includes(fightType)) {
                            // Parse fighters
                            const fighterA = new SFFighter(header.slice(05, 52), fightType);
                            const fighterB = new SFFighter(header.slice(52, 99), fightType);

                            // Parse individual rounds (group of 3 numbers)
                            const rawRounds = [];
                            for (let i = 0; i < rounds.length / 3; i++) {
                                rawRounds.push(_slice_len(rounds, i * 3, 3));
                            }

                            // Process each round
                            const processedRounds = [];
                            for (const [attackerId, attackType, targetHealthLeft] of rawRounds) {
                                const [attacker, target] = attackerId == fighterA.ID ? [fighterA, fighterB] : [fighterB, fighterA];

                                processedRounds.push(Object.assign({
                                    attacker,
                                    target,
                                    attackType,
                                    attackDamage: 0,
                                    targetHealthLeft,
                                }, decodeAttackType(attackType)));
                            }

                            const findHealth = (i) => {
                                const currentRound = processedRounds[i];
                                for (let j = i - 1, round; round = processedRounds[j]; j--) {
                                    if (round.attacker == currentRound.attacker && !round.attackSpecial) {
                                        return round.targetHealthLeft;
                                    }
                                }

                                return currentRound.target.Life;
                            }

                            // Finalize each round
                            let attackRageOffset = 0;
                            for (let i = 0, round; round = processedRounds[i]; i++) {
                                // Calculate attack damage
                                if (round.attackSpecial) {
                                    round.attackDamage = round.targetHealthLeft;
                                } else {
                                    round.attackDamage = findHealth(i) - round.targetHealthLeft;
                                }

                                // Calculate attack rage
                                if (round.attackSpecial) {
                                    attackRageOffset--;
                                } else if (round.attackChained) {
                                    attackRageOffset++;
                                }

                                round.attackRage = 1 + ((i - attackRageOffset) / 6);

                                // Calculate base damage
                                round.attackBase = round.attackDamage / round.attackRage;
                            }

                            // Push fight
                            processedFights.push({
                                fighterA,
                                fighterB,
                                winner: winner_id == fighterA.ID ? fighterA : fighterB,
                                rounds: processedRounds
                            })
                        }
                    }

                    const processedPlayers = [];
                    // Convert all player data into actual player models and optionally companions
                    for (const data of digestedPlayers) {
                        const { own, save, name, pets, tower } = data;

                        if (own) {
                            // Add own player
                            const player = new SFOwnPlayer(data);
                            processedPlayers.push(player);

                            // Add companions if present
                            if (player.Companions) {
                                processedPlayers.push(
                                    player.Companions.Bert,
                                    player.Companions.Mark,
                                    player.Companions.Kunigunde
                                )
                            }
                        } else {
                            // Add other player
                            const player = new SFOtherPlayer(data);
                            processedPlayers.push(player);
                        }
                    }

                    // Compute hashes for all players and fighters
                    for (const { fighterA, fighterB } of processedFights) {
                        fighterA.Hash = computePlayerHash(fighterA);
                        fighterB.Hash = computePlayerHash(fighterB);
                    }

                    for (const player of processedPlayers) {
                        player.Model = createFighterModel(player);
                        player.Hash = computePlayerHash(player);
                    }

                    // Merge fighters and hashes
                    for (const { fighterA, fighterB } of processedFights) {
                        const playerA = processedPlayers.find((player) => player.Hash === fighterA.Hash);
                        if (playerA) {
                            fighterA.Player = playerA;
                        }

                        const playerB = processedPlayers.find((player) => player.Hash === fighterB.Hash);
                        if (playerB) {
                            fighterB.Player = playerB;
                        }
                    }

                    console.log(processedFights, processedPlayers)
                }
            })
        </script>
    </body>
</html>
